<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Nota & Stok</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for elegance and overrides for Tailwind where necessary */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: bold; /* All text bold as requested */
        }

        /* Hide number input arrows */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Specific styles for quantity and price inputs to remove inner borders */
        .qty-price-group input[type="number"] {
            border: none !important; /* Force no border */
            box-shadow: none !important; /* Force no shadow */
            background-color: transparent !important; /* Transparent background */
            border-bottom: 1px solid #d1d5db !important; /* Light gray bottom border */
            border-radius: 0 !important; /* No border radius for clean bottom line */
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Mobile navigation adjustments */
        .mobile-nav {
            display: none; /* Hidden by default, shown by media query */
            width: 100%;
            background-color: white;
            padding: 0.5rem 0;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 999;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            justify-content: space-around;
            align-items: center;
        }
        .mobile-nav button {
            background-color: transparent;
            color: #6b7280; /* gray-500 */
            border: none;
            padding: 0.5rem 0.25rem;
            margin: 0;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.8em;
            transition: color 0.3s ease;
            flex-direction: column;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            min-width: 60px;
        }
        .mobile-nav button i {
            font-size: 1.4em;
            margin-bottom: 0.25rem;
        }
        .mobile-nav button.active {
            color: #22c55e; /* green-500 */
        }
        .mobile-nav button:hover:not(.active) {
            color: #3b82f6; /* blue-500 */
        }
        .mobile-nav button span.nav-label {
            display: block;
        }

        /* Content sections for mobile nav */
        .content-section {
            display: none;
            width: 100%;
        }
        .content-section.active {
            display: block;
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }
            body {
                padding-bottom: 60px; /* Space for fixed bottom nav */
            }
            .main-content-wrapper {
                margin-bottom: 60px; /* Adjust margin for fixed nav */
            }
        }
        @media (max-width: 480px) {
            .mobile-nav button span.nav-label {
                display: none;
            }
            .mobile-nav button i {
                font-size: 1.6em;
            }
            .mobile-nav {
                padding: 0.75rem 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen pb-16 text-gray-800">
    <!-- Main Content Wrapper for all sections -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section active" id="penjualanSection">
        <h1 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Aplikasi Nota Penjualan</h1>

        <div class="mb-4">
            <label for="namaToko" class="block text-gray-700 text-sm mb-2">Nama Toko:</label>
            <input type="text" id="namaToko" placeholder="Contoh: Toko Barokah"
                   class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <div class="flex flex-wrap -mx-2 mb-4">
            <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
                <label for="tanggalPenjualan" class="block text-gray-700 text-sm mb-2">Tanggal Nota:</label>
                <input type="date" id="tanggalPenjualan"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="w-full md:w-1/2 px-2">
                <label for="namaPembeli" class="block text-gray-700 text-sm mb-2">Nama Pembeli:</label>
                <input type="text" id="namaPembeli" placeholder="Masukkan nama pembeli"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <h2 class="text-xl font-bold text-center text-gray-900 mb-4">Daftar Barang Penjualan</h2>
        <div class="flex items-end gap-2 mb-4">
            <div class="flex-grow">
                <label for="namaBarangPenjualan" class="block text-gray-700 text-sm mb-2">Nama Barang:</label>
                <input type="text" id="namaBarangPenjualan" placeholder="Cari atau masukkan nama barang"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div id="namaBarangSuggestionsPenjualan" class="absolute bg-white border border-gray-300 rounded-b-lg w-full max-h-40 overflow-y-auto z-10 shadow-md"></div>
            </div>
            <button class="search-icon-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200"
                    onclick="openMasterItemModal('penjualan')">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="flex flex-wrap -mx-2 mb-4 qty-price-group">
            <div class="w-1/2 md:w-1/3 px-2 mb-4 md:mb-0 form-item">
                <label for="jumlahKuantitasPenjualan" class="block text-gray-700 text-sm mb-2">Jumlah Kuantitas:</label>
                <input type="number" id="jumlahKuantitasPenjualan" placeholder="Qty"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="w-1/2 md:w-1/3 px-2 mb-4 md:mb-0 form-item">
                <label for="hargaSatuanPenjualan" class="block text-gray-700 text-sm mb-2">Harga Satuan (Rp.):</label>
                <input type="number" id="hargaSatuanPenjualan" placeholder="Harga Jual"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="w-full md:w-1/3 px-2 form-item">
                <label for="hargaBeliPenjualan" class="block text-gray-700 text-sm mb-2">Harga Beli (Rp.):</label>
                <input type="number" id="hargaBeliPenjualan" placeholder="Harga Beli"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <div class="flex justify-center gap-4 mb-6">
            <button onclick="tambahAtauUpdateBarangPenjualan()" id="btnAddUpdatePenjualan"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                Tambah Barang
            </button>
            <button onclick="batalEditPenjualan()" id="btnCancelEditPenjualan" style="display: none;"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                Batal Edit
            </button>
        </div>

        <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Satuan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Laba/Rugi</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="daftarBelanjaPenjualan" class="divide-y divide-gray-200">
                    <!-- Data barang akan ditambahkan di sini oleh JS -->
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="total-row">
                        <td colspan="5" class="py-2 px-3 text-right text-sm font-bold text-gray-900">Total Penjualan:</td>
                        <td id="grandTotalPenjualan" class="py-2 px-3 text-left text-sm font-bold text-gray-900">Rp. 0</td>
                        <td id="grandTotalLabaRugi" class="py-2 px-3 text-left text-sm font-bold text-gray-900">Rp. 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <button onclick="selesaikanPembayaran()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                Selesaikan Pembayaran
            </button>
            <button onclick="simpanTransaksiPending()"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition duration-200">
                Simpan Transaksi Pending
            </button>
        </div>

        <div id="strukOutputPenjualan" class="mt-8 pt-4 border-t border-dashed border-gray-300" style="display: none;">
            <h2 class="text-xl font-bold text-center text-gray-900 mb-4">Preview Struk Penjualan</h2>
            <p id="strukNamaTokoPenjualan" class="text-center text-gray-700 mb-1"></p>
            <p id="strukTanggalPembeliPenjualan" class="text-center text-gray-700 mb-4"></p>
            <div id="strukItemsPenjualan" class="mb-4">
                <!-- Struk item akan ditampilkan di sini -->
            </div>
            <p class="text-right text-lg font-bold text-gray-900" id="strukGrandTotalPenjualanPreview"></p>
        </div>

        <div id="shareButtonsPenjualan" class="flex justify-center gap-4 mt-6" style="display: none;">
            <button onclick="shareViaWhatsAppPenjualan()"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition duration-200">
                <i class="fab fa-whatsapp mr-2"></i> Bagikan Via WhatsApp
            </button>
        </div>
    </div>

    <!-- Pembelian Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="pembelianSection">
        <h1 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Aplikasi Nota Pembelian</h1>

        <div class="mb-4">
            <label for="namaSupplier" class="block text-gray-700 text-sm mb-2">Nama Supplier:</label>
            <input type="text" id="namaSupplier" placeholder="Contoh: PT. Maju Jaya"
                   class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <div class="mb-4">
            <label for="tanggalPembelian" class="block text-gray-700 text-sm mb-2">Tanggal Nota Pembelian:</label>
            <input type="date" id="tanggalPembelian"
                   class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <h2 class="text-xl font-bold text-center text-gray-900 mb-4">Daftar Barang Pembelian</h2>
        <div class="flex items-end gap-2 mb-4">
            <div class="flex-grow">
                <label for="namaBarangPembelian" class="block text-gray-700 text-sm mb-2">Nama Barang:</label>
                <input type="text" id="namaBarangPembelian" placeholder="Cari atau masukkan nama barang"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div id="namaBarangSuggestionsPembelian" class="absolute bg-white border border-gray-300 rounded-b-lg w-full max-h-40 overflow-y-auto z-10 shadow-md"></div>
            </div>
            <button class="search-icon-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200"
                    onclick="openMasterItemModal('pembelian')">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <div class="flex flex-wrap -mx-2 mb-4 qty-price-group">
            <div class="w-1/2 md:w-1/2 px-2 mb-4 md:mb-0 form-item">
                <label for="jumlahKuantitasPembelian" class="block text-gray-700 text-sm mb-2">Jumlah Kuantitas:</label>
                <input type="number" id="jumlahKuantitasPembelian" placeholder="Qty"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="w-1/2 md:w-1/2 px-2 form-item">
                <label for="hargaBeliPembelian" class="block text-gray-700 text-sm mb-2">Harga Beli (Rp.):</label>
                <input type="number" id="hargaBeliPembelian" placeholder="Harga Beli"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <div class="flex justify-center gap-4 mb-6">
            <button onclick="tambahAtauUpdateBarangPembelian()" id="btnAddUpdatePembelian"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200">
                Tambah Barang
            </button>
            <button onclick="batalEditPembelian()" id="btnCancelEditPembelian" style="display: none;"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                Batal Edit
            </button>
        </div>

        <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="daftarBelanjaPembelian" class="divide-y divide-gray-200">
                    <!-- Data barang akan ditambahkan di sini oleh JS -->
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr class="total-row">
                        <td colspan="4" class="py-2 px-3 text-right text-sm font-bold text-gray-900">Total Pembelian:</td>
                        <td id="grandTotalPembelian" class="py-2 px-3 text-left text-sm font-bold text-gray-900">Rp. 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="flex justify-center gap-4 mb-6">
            <button onclick="simpanNotaPembelian()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                Simpan Nota Pembelian
            </button>
        </div>

        <div id="strukOutputPembelian" class="mt-8 pt-4 border-t border-dashed border-gray-300" style="display: none;">
            <h2 class="text-xl font-bold text-center text-gray-900 mb-4">Preview Nota Pembelian</h2>
            <p id="strukNamaSupplierPembelian" class="text-center text-gray-700 mb-1"></p>
            <p id="strukTanggalPembelianPreview" class="text-center text-gray-700 mb-4"></p>
            <div id="strukItemsPembelian" class="mb-4">
                <!-- Struk item akan ditampilkan di sini -->
            </div>
            <p class="text-right text-lg font-bold text-gray-900" id="strukGrandTotalPembelianPreview"></p>
        </div>

        <div id="shareButtonsPembelian" class="flex justify-center gap-4 mt-6" style="display: none;">
            <button onclick="shareViaWhatsAppPembelian()"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition duration-200">
                <i class="fab fa-whatsapp mr-2"></i> Bagikan Via WhatsApp
            </button>
        </div>
    </div>

    <!-- Master Items Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="masterSection">
        <h2 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Daftar Barang Master</h2>
        <div class="flex justify-end gap-3 mb-4">
            <button onclick="backupMasterItems()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 flex items-center gap-2">
                <i class="fas fa-download"></i> Backup
            </button>
            <button onclick="document.getElementById('restoreFileInput').click()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 flex items-center gap-2">
                <i class="fas fa-upload"></i> Restore
            </button>
            <input type="file" id="restoreFileInput" accept=".json" class="hidden">
        </div>
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Satuan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="masterItemsList" class="divide-y divide-gray-200">
                    <!-- Master items will be loaded here by JS -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-6">
            <button id="clearMasterItemsBtn" onclick="clearMasterItems()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                Hapus Semua Barang Master
            </button>
        </div>
    </div>

    <!-- History Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="historySection">
        <h2 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Riwayat Transaksi</h2>
        
        <h3 class="text-xl font-bold text-gray-900 mb-4">Riwayat Penjualan</h3>
        <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Nota</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pembeli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Penjualan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Laba/Rugi</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="salesHistoryListBody" class="divide-y divide-gray-200">
                    <!-- Histori penjualan akan dimuat di sini oleh JS -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-6">
            <button id="clearSalesHistoryBtn" onclick="clearSalesHistory()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                Hapus Semua Riwayat Penjualan
            </button>
        </div>

        <h3 class="text-xl font-bold text-gray-900 mt-8 mb-4">Riwayat Pembelian</h3>
        <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Nota</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Pembelian</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="purchaseHistoryListBody" class="divide-y divide-gray-200">
                    <!-- Histori pembelian akan dimuat di sini oleh JS -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-6">
            <button id="clearPurchaseHistoryBtn" onclick="clearPurchaseHistory()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                Hapus Semua Riwayat Pembelian
            </button>
        </div>
    </div>

    <!-- Pending Transactions Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="pendingSection">
        <h2 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Transaksi Penjualan Tertunda</h2>
        <div class="overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Transaksi</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pembeli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="pendingSalesList" class="divide-y divide-gray-200">
                    <!-- Pending sales will be loaded here by JS -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-6">
            <button id="clearPendingSalesBtn" onclick="clearPendingSales()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                Hapus Semua Transaksi Pending
            </button>
        </div>
    </div>

    <!-- Profit Loss Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="profitLossSection">
        <h2 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Laporan Rugi Laba</h2>

        <div class="flex flex-wrap gap-3 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div class="flex-1 min-w-[120px]">
                <label for="filterStartDate" class="block text-gray-700 text-sm mb-1">Dari Tanggal:</label>
                <input type="date" id="filterStartDate"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label for="filterEndDate" class="block text-gray-700 text-sm mb-1">Sampai Tanggal:</label>
                <input type="date" id="filterEndDate"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label for="filterItemName" class="block text-gray-700 text-sm mb-1">Nama Barang:</label>
                <input type="text" id="filterItemName" placeholder="Filter per barang"
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <button onclick="generateProfitLossReport()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 self-end">
                Filter Laporan
            </button>
        </div>

        <h3 class="text-xl font-bold text-gray-900 mb-4">Rugi Laba Harian</h3>
        <div class="report-table-container overflow-x-auto rounded-lg shadow-md mb-6">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Penjualan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Laba/Rugi Harian</th>
                    </tr>
                </thead>
                <tbody id="dailyProfitLossList" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <h3 class="text-xl font-bold text-gray-900 mb-4">Rugi Laba per Transaksi</h3>
        <div class="report-table-container overflow-x-auto rounded-lg shadow-md mb-6">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Nota</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pembeli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Penjualan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Laba/Rugi Transaksi</th>
                    </tr>
                </thead>
                <tbody id="transactionProfitLossList" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <h3 class="text-xl font-bold text-gray-900 mb-4">Rugi Laba per Barang</h3>
        <div class="report-table-container overflow-x-auto rounded-lg shadow-md mb-6">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Penjualan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Harga Beli</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Laba/Rugi per Barang</th>
                    </tr>
                </thead>
                <tbody id="itemProfitLossList" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>

        <div class="report-summary p-4 bg-green-100 rounded-lg font-bold text-gray-900">
            <p>Total Laba/Rugi Filtered: <span id="totalFilteredProfitLoss">Rp. 0</span></p>
        </div>
    </div>

    <!-- Stock Report Section -->
    <div class="main-content-wrapper w-full max-w-xl p-6 bg-white rounded-xl shadow-lg mt-5 mb-5 content-section" id="stockSection">
        <h2 class="text-2xl font-extrabold text-center text-gray-900 mb-6">Laporan Stok Barang</h2>

        <div class="flex flex-wrap gap-3 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div class="flex-1 min-w-[120px]">
                <label for="stockFilterItemName" class="block text-gray-700 text-sm mb-1">Nama Barang:</label>
                <input type="text" id="stockFilterItemName" placeholder="Cari barang..."
                       class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            <button onclick="generateStockReport()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 self-end">
                Filter Stok
            </button>
        </div>

        <div class="report-table-container overflow-x-auto rounded-lg shadow-md">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Saat Ini</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Satuan</th>
                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                    </tr>
                </thead>
                <tbody id="stockReportList" class="divide-y divide-gray-200">
                    <!-- Stock data will be loaded here by JS -->
                </tbody>
            </table>
        </div>
        <p class="text-sm text-gray-600 mt-4">*(Catatan: Stok dihitung berdasarkan master barang dan transaksi penjualan/pembelian yang tercatat.)*</p>
    </div>

    <!-- Master Item Search Modal -->
    <div id="masterItemModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeMasterItemModal()">&times;</span>
            <h2 class="text-xl font-bold text-gray-900 mb-4">Pilih Barang Master</h2>
            <input type="text" id="masterItemSearchInput" placeholder="Cari barang..."
                   class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="modalMasterItemsTable" class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Satuan</th>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pilih</th>
                        </tr>
                    </thead>
                    <tbody id="modalMasterItemsList" class="divide-y divide-gray-200">
                        <!-- Master items for modal will be loaded here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Message Box Modal -->
    <div id="customMessageBox" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeMessageBox()">&times;</span>
            <p id="messageBoxText" class="text-gray-800 text-base mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="messageBoxConfirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200" style="display: none;">OK</button>
                <button id="messageBoxCancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200" style="display: none;">Batal</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation (Bottom Fixed) -->
    <div class="mobile-nav flex justify-around items-center">
        <button id="navPenjualan" class="active" onclick="showSection('penjualan', this)">
            <i class="fas fa-cash-register"></i>
            <span class="nav-label">Penjualan</span>
        </button>
        <button id="navPembelian" onclick="showSection('pembelian', this)">
            <i class="fas fa-shopping-basket"></i>
            <span class="nav-label">Pembelian</span>
        </button>
        <button id="navMaster" onclick="showSection('master', this)">
            <i class="fas fa-boxes"></i>
            <span class="nav-label">Master</span>
        </button>
        <button id="navPending" onclick="showSection('pending', this)">
            <i class="fas fa-hourglass-half"></i>
            <span class="nav-label">Pending</span>
        </button>
        <button id="navHistory" onclick="showSection('history', this)">
            <i class="fas fa-history"></i>
            <span class="nav-label">Riwayat</span>
        </button>
        <button id="navProfitLoss" onclick="showSection('profitLoss', this)">
            <i class="fas fa-chart-line"></i>
            <span class="nav-label">Rugi Laba</span>
        </button>
        <button id="navStock" onclick="showSection('stock', this)">
            <i class="fas fa-warehouse"></i>
            <span class="nav-label">Stok</span>
        </button>
    </div>

    <script>
        let currentItems = []; // Items for the current active transaction (sale or purchase)
        let currentTransactionType = 'penjualan'; // 'penjualan' or 'pembelian'
        let currentGrandTotalPenjualan = 0;
        let currentGrandTotalLabaRugi = 0;
        let currentGrandTotalPembelian = 0;
        let itemCounter = 0; // Unique ID for current items
        let editingItemId = null;
        let salesHistory = []; // Stored sales receipts
        let purchaseHistory = []; // Stored purchase receipts
        let pendingSales = []; // Stored pending sales transactions
        let masterItems = []; // Master list of products

        // --- Initialization on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', (event) => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            document.getElementById('tanggalPenjualan').value = formattedDate;
            document.getElementById('tanggalPembelian').value = formattedDate;

            loadNamaToko();
            loadHistory(); // Loads both sales and purchase history
            loadPendingSales();
            loadMasterItems();

            // Event listeners for autocomplete
            document.getElementById('namaBarangPenjualan').addEventListener('input', () => showSuggestions('penjualan'));
            document.getElementById('namaBarangPenjualan').addEventListener('blur', () => {
                setTimeout(() => { document.getElementById('namaBarangSuggestionsPenjualan').innerHTML = ''; }, 100);
            });
            document.getElementById('namaBarangPembelian').addEventListener('input', () => showSuggestions('pembelian'));
            document.getElementById('namaBarangPembelian').addEventListener('blur', () => {
                setTimeout(() => { document.getElementById('namaBarangSuggestionsPembelian').innerHTML = ''; }, 100);
            });

            // Event listener for Restore file input
            document.getElementById('restoreFileInput').addEventListener('change', restoreMasterItems);

            // Set default section to 'penjualan' on load
            showSection('penjualan', document.getElementById('navPenjualan'));

            // Set default filter dates for reports
            document.getElementById('filterStartDate').value = `${year}-${month}-01`;
            document.getElementById('filterEndDate').value = formattedDate;
        });

        // --- Utility Functions ---
        function formatRupiah(angka) {
            let reverse = String(angka).split('').reverse().join('');
            let ribuan = reverse.match(/\d{1,3}/g);
            let result = ribuan.join('.').split('').reverse().join('');
            return `Rp. ${result}`;
        }

        function hitungUlangTotal(type) {
            if (type === 'penjualan') {
                currentGrandTotalPenjualan = 0;
                currentGrandTotalLabaRugi = 0;
                currentItems.forEach(item => {
                    currentGrandTotalPenjualan += item.jumlah;
                    currentGrandTotalLabaRugi += item.labaRugi;
                });
                document.getElementById('grandTotalPenjualan').innerText = formatRupiah(currentGrandTotalPenjualan);
                document.getElementById('grandTotalLabaRugi').innerText = formatRupiah(currentGrandTotalLabaRugi);
            } else if (type === 'pembelian') {
                currentGrandTotalPembelian = 0;
                currentItems.forEach(item => {
                    currentGrandTotalPembelian += item.jumlah;
                });
                document.getElementById('grandTotalPembelian').innerText = formatRupiah(currentGrandTotalPembelian);
            }
        }

        function clearBarangInputs(type) {
            if (type === 'penjualan') {
                document.getElementById('namaBarangPenjualan').value = '';
                document.getElementById('jumlahKuantitasPenjualan').value = '';
                document.getElementById('hargaSatuanPenjualan').value = '';
                document.getElementById('hargaBeliPenjualan').value = '';
                document.getElementById('namaBarangPenjualan').focus();
                document.getElementById('namaBarangSuggestionsPenjualan').innerHTML = '';
            } else if (type === 'pembelian') {
                document.getElementById('namaBarangPembelian').value = '';
                document.getElementById('jumlahKuantitasPembelian').value = '';
                document.getElementById('hargaBeliPembelian').value = '';
                document.getElementById('namaBarangPembelian').focus();
                document.getElementById('namaBarangSuggestionsPembelian').innerHTML = '';
            }
        }

        function resetCurrentTransaction(type) {
            currentItems = [];
            itemCounter = 0;
            editingItemId = null;
            if (type === 'penjualan') {
                document.getElementById('namaPembeli').value = '';
                currentGrandTotalPenjualan = 0;
                currentGrandTotalLabaRugi = 0;
                renderTablePenjualan();
                clearBarangInputs('penjualan');
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                document.getElementById('tanggalPenjualan').value = `${year}-${month}-${day}`;
            } else if (type === 'pembelian') {
                document.getElementById('namaSupplier').value = '';
                currentGrandTotalPembelian = 0;
                renderTablePembelian();
                clearBarangInputs('pembelian');
                document.getElementById('strukOutputPembelian').style.display = 'none';
                document.getElementById('shareButtonsPembelian').style.display = 'none';
                document.getElementById('strukNamaSupplierPembelian').innerText = '';
                document.getElementById('strukTanggalPembelianPreview').innerText = '';
                document.getElementById('strukItemsPembelian').innerHTML = '';
                document.getElementById('strukGrandTotalPembelianPreview').innerText = '';
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                document.getElementById('tanggalPembelian').value = `${year}-${month}-${day}`;
            }
        }

        // Function to clear only the sales preview area
        function clearSalesPreview() {
            document.getElementById('strukOutputPenjualan').style.display = 'none';
            document.getElementById('shareButtonsPenjualan').style.display = 'none';
            document.getElementById('strukNamaTokoPenjualan').innerText = '';
            document.getElementById('strukTanggalPembeliPenjualan').innerText = '';
            document.getElementById('strukItemsPenjualan').innerHTML = '';
            document.getElementById('strukGrandTotalPenjualanPreview').innerText = '';
        }

        // --- Tab Navigation ---
        // Parameter keepCurrentTransaction: jika true, form dan currentItems tidak akan direset saat beralih tab.
        // Ini berguna saat memuat transaksi pending atau riwayat.
        function showSection(sectionId, clickedButton, keepCurrentTransaction = false) {
            const sections = document.querySelectorAll('.main-content-wrapper.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}Section`).classList.add('active');

            const navButtons = document.querySelectorAll('.mobile-nav button');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            currentTransactionType = sectionId;

            // Hanya reset jika tidak diminta untuk mempertahankan transaksi saat ini
            if (!keepCurrentTransaction) {
                if (sectionId === 'penjualan') {
                    clearSalesPreview(); // Kosongkan pratinjau penjualan saat masuk tab penjualan
                    resetCurrentTransaction('penjualan'); // Reset form untuk penjualan baru
                } else if (sectionId === 'pembelian') {
                    resetCurrentTransaction('pembelian');
                }
            }

            // Refresh reports/lists if applicable
            if (sectionId === 'history') {
                renderSalesHistory();
                renderPurchaseHistory();
            } else if (sectionId === 'pending') {
                renderPendingSales();
            } else if (sectionId === 'profitLoss') {
                generateProfitLossReport();
            } else if (sectionId === 'stock') {
                generateStockReport();
            }
        }

        // --- Penjualan Management ---
        function tambahAtauUpdateBarangPenjualan() {
            const namaBarang = document.getElementById('namaBarangPenjualan').value.trim();
            const jumlahKuantitas = parseInt(document.getElementById('jumlahKuantitasPenjualan').value);
            const hargaSatuan = parseInt(document.getElementById('hargaSatuanPenjualan').value);
            const hargaBeli = parseInt(document.getElementById('hargaBeliPenjualan').value || '0');

            if (!namaBarang || isNaN(jumlahKuantitas) || isNaN(hargaSatuan)) {
                showMessageBox('Mohon lengkapi Nama Barang, Kuantitas, dan Harga Satuan.');
                return;
            }
            if (jumlahKuantitas <= 0) {
                showMessageBox('Jumlah Kuantitas harus lebih dari 0.');
                return;
            }
            if (hargaSatuan < 0 || hargaBeli < 0) {
                showMessageBox('Harga tidak boleh negatif.');
                return;
            }

            // Kosongkan pratinjau penjualan jika menambahkan item baru ke transaksi
            clearSalesPreview();


            const jumlah = jumlahKuantitas * hargaSatuan;
            const labaRugi = (jumlahKuantitas * hargaSatuan) - (jumlahKuantitas * hargaBeli);

            if (editingItemId !== null) {
                const itemIndex = currentItems.findIndex(item => item.id === editingItemId);
                if (itemIndex > -1) {
                    currentItems[itemIndex].nama = namaBarang;
                    currentItems[itemIndex].qty = jumlahKuantitas;
                    currentItems[itemIndex].hargaSatuan = hargaSatuan;
                    currentItems[itemIndex].hargaBeli = hargaBeli;
                    currentItems[itemIndex].jumlah = jumlah;
                    currentItems[itemIndex].labaRugi = labaRugi;
                }
                editingItemId = null;
                document.getElementById('btnAddUpdatePenjualan').innerText = 'Tambah Barang';
                document.getElementById('btnCancelEditPenjualan').style.display = 'none';
            } else {
                itemCounter++;
                const newItem = {
                    id: itemCounter,
                    nama: namaBarang,
                    qty: jumlahKuantitas,
                    hargaSatuan: hargaSatuan,
                    hargaBeli: hargaBeli,
                    jumlah: jumlah,
                    labaRugi: labaRugi
                };
                currentItems.push(newItem);
            }

            // Update master item prices if they are new or changed
            addOrUpdateMasterItem(namaBarang, hargaSatuan, hargaBeli);
            saveMasterItems(); // Save master items after price update

            hitungUlangTotal('penjualan');
            renderTablePenjualan();
            clearBarangInputs('penjualan');
        }

        function editBarangPenjualan(id) {
            const itemToEdit = currentItems.find(item => item.id === id);
            if (itemToEdit) {
                document.getElementById('namaBarangPenjualan').value = itemToEdit.nama;
                document.getElementById('jumlahKuantitasPenjualan').value = itemToEdit.qty;
                document.getElementById('hargaSatuanPenjualan').value = itemToEdit.hargaSatuan;
                document.getElementById('hargaBeliPenjualan').value = itemToEdit.hargaBeli;

                document.getElementById('btnAddUpdatePenjualan').innerText = 'Update Barang';
                document.getElementById('btnCancelEditPenjualan').style.display = 'inline-block';
                editingItemId = id;
            }
        }

        function deleteBarangPenjualan(id) {
            showMessageBox('Apakah Anda yakin ingin menghapus barang ini dari daftar saat ini?', true, () => {
                currentItems = currentItems.filter(item => item.id !== id);
                hitungUlangTotal('penjualan');
                renderTablePenjualan();
                batalEditPenjualan();
                clearSalesPreview(); // Kosongkan pratinjau jika item dihapus
            });
        }

        function batalEditPenjualan() {
            editingItemId = null;
            document.getElementById('btnAddUpdatePenjualan').innerText = 'Tambah Barang';
            document.getElementById('btnCancelEditPenjualan').style.display = 'none';
            clearBarangInputs('penjualan');
        }

        function renderTablePenjualan() {
            const daftarBelanja = document.getElementById('daftarBelanjaPenjualan');
            daftarBelanja.innerHTML = '';

            if (currentItems.length === 0) {
                daftarBelanja.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Belum ada barang dalam daftar penjualan.</td></tr>';
            }

            currentItems.forEach(item => {
                const row = daftarBelanja.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = item.id;
                row.insertCell(1).innerText = item.nama;
                row.insertCell(2).innerText = item.qty;
                row.insertCell(3).innerText = formatRupiah(item.hargaSatuan);
                row.insertCell(4).innerText = formatRupiah(item.hargaBeli);
                row.insertCell(5).innerText = formatRupiah(item.jumlah);
                row.insertCell(6).innerText = formatRupiah(item.labaRugi);

                const actionCell = row.insertCell(7);
                actionCell.classList.add('action-buttons', 'flex', 'gap-2', 'py-2');
                const editButton = document.createElement('button');
                editButton.innerText = 'Edit';
                editButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                editButton.onclick = () => editBarangPenjualan(item.id);
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deleteBarangPenjualan(item.id);
                actionCell.appendChild(deleteButton);
            });
        }

        function selesaikanPembayaran() {
            if (currentItems.length === 0) {
                showMessageBox('Tambahkan barang terlebih dahulu sebelum menyelesaikan pembayaran.');
                return;
            }

            // Kurangi stok untuk barang yang terjual
            currentItems.forEach(item => {
                const masterItem = masterItems.find(mi => mi.name === item.nama);
                if (masterItem) {
                    masterItem.stock -= item.qty;
                }
            });
            saveMasterItems(); // Simpan master item setelah perubahan stok

            const namaToko = document.getElementById('namaToko').value || 'Nama Toko';
            const tanggal = document.getElementById('tanggalPenjualan').value;
            const namaPembeli = document.getElementById('namaPembeli').value || 'Pelanggan Yth.';

            const newStruk = {
                id: Date.now(),
                tanggal: tanggal,
                pembeli: namaPembeli,
                toko: namaToko,
                items: JSON.parse(JSON.stringify(currentItems)),
                totalPenjualan: currentGrandTotalPenjualan,
                totalLabaRugi: currentGrandTotalLabaRugi
            };

            salesHistory.push(newStruk);
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));

            renderStrukPreviewPenjualan(newStruk); // Render pratinjau menggunakan data struk yang baru selesai
            document.getElementById('strukOutputPenjualan').style.display = 'block'; // Tampilkan area pratinjau
            document.getElementById('shareButtonsPenjualan').style.display = 'flex'; // Tampilkan tombol share
            showMessageBox('Pembayaran berhasil diselesaikan dan struk siap dibagikan!');
            
            // Reset input form untuk transaksi baru, tapi biarkan pratinjau tetap terlihat
            resetCurrentTransaction('penjualan');
        }

        function renderStrukPreviewPenjualan(strukData) {
            // Gunakan strukData yang dilewatkan untuk pratinjau, bukan currentItems global
            const namaToko = strukData.toko || 'Nama Toko';
            const tanggal = strukData.tanggal;
            const namaPembeli = strukData.pembeli || 'Pelanggan Yth.';

            document.getElementById('strukNamaTokoPenjualan').innerText = `Nama Toko: ${namaToko}`;
            document.getElementById('strukTanggalPembeliPenjualan').innerText = `Tanggal: ${tanggal} | Pembeli: ${namaPembeli}`;

            const strukItemsDiv = document.getElementById('strukItemsPenjualan');
            strukItemsDiv.innerHTML = '';

            strukData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row', 'flex', 'justify-between', 'flex-wrap', 'mb-1');
                itemDiv.innerHTML = `
                    <span class="item-name flex-1 min-w-[50%]">${item.nama}</span>
                    <span class="item-qty-price text-right flex-grow-0 flex-shrink-0 w-[120px]">${item.qty} x ${formatRupiah(item.hargaSatuan)}</span>
                    <span class="item-total w-[80px] text-right ml-auto">${formatRupiah(item.jumlah)}</span>
                `;
                strukItemsDiv.appendChild(itemDiv);
            });
            document.getElementById('strukGrandTotalPenjualanPreview').innerText = `Total: ${formatRupiah(strukData.totalPenjualan)}`;
        }

        function shareViaWhatsAppPenjualan() {
            // Ambil data struk terakhir yang dihasilkan untuk dibagikan
            const lastStruk = salesHistory[salesHistory.length - 1];
            if (!lastStruk) {
                showMessageBox('Tidak ada struk untuk dibagikan.');
                return;
            }

            const namaToko = lastStruk.toko || 'Nama Toko';
            const tanggal = lastStruk.tanggal;
            const namaPembeli = lastStruk.pembeli || 'Pelanggan Yth.';

            let message = `*NOTA PENJUALAN*\n\n`; // Changed to PENJUALAN
            message += `*${namaToko}*\n`;
            message += `Tanggal: ${tanggal}\n`;
            message += `Pembeli: ${namaPembeli}\n`;
            message += `\n`;

            message += `*Daftar Barang:*\n`;
            lastStruk.items.forEach((item, index) => {
                message += `${index + 1}. ${item.nama} (${item.qty} x ${formatRupiah(item.hargaSatuan)}) = ${formatRupiah(item.jumlah)}\n`;
            });

            message += `\n------------------------------\n`;
            message += `*TOTAL PENJUALAN: ${formatRupiah(lastStruk.totalPenjualan)}*\n`;
            message += `------------------------------\n`;
            message += `\nTerima kasih atas kunjungan Anda!\n`;
            message += `_Dibuat dengan Aplikasi Nota & Stok_`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function simpanTransaksiPending() {
            if (currentItems.length === 0) {
                showMessageBox('Tidak ada barang untuk disimpan sebagai transaksi pending.');
                return;
            }

            const tanggal = document.getElementById('tanggalPenjualan').value;
            const namaPembeli = document.getElementById('namaPembeli').value || 'Pelanggan Yth.';
            const namaToko = document.getElementById('namaToko').value || 'Nama Toko';

            const newPendingTransaction = {
                id: Date.now(),
                tanggal: tanggal,
                pembeli: namaPembeli,
                toko: namaToko,
                items: JSON.parse(JSON.stringify(currentItems)),
                totalPenjualan: currentGrandTotalPenjualan,
                totalLabaRugi: currentGrandTotalLabaRugi
            };

            pendingSales.push(newPendingTransaction);
            localStorage.setItem('pendingSales', JSON.stringify(pendingSales));
            showMessageBox('Transaksi berhasil disimpan sebagai pending!');
            resetCurrentTransaction('penjualan'); // Kosongkan form untuk transaksi baru
            clearSalesPreview(); // Kosongkan pratinjau penjualan juga
        }

        // --- Pembelian Management ---
        function tambahAtauUpdateBarangPembelian() {
            const namaBarang = document.getElementById('namaBarangPembelian').value.trim();
            const jumlahKuantitas = parseInt(document.getElementById('jumlahKuantitasPembelian').value);
            const hargaBeli = parseInt(document.getElementById('hargaBeliPembelian').value || '0');

            if (!namaBarang || isNaN(jumlahKuantitas) || isNaN(hargaBeli)) {
                showMessageBox('Mohon lengkapi Nama Barang, Kuantitas, dan Harga Beli.');
                return;
            }
            if (jumlahKuantitas <= 0) {
                showMessageBox('Jumlah Kuantitas harus lebih dari 0.');
                return;
            }
            if (hargaBeli < 0) {
                showMessageBox('Harga beli tidak boleh negatif.');
                return;
            }

            const jumlah = jumlahKuantitas * hargaBeli; // Total pembelian untuk item ini

            if (editingItemId !== null) {
                const itemIndex = currentItems.findIndex(item => item.id === editingItemId);
                if (itemIndex > -1) {
                    // Kembalikan stok untuk kuantitas lama
                    const oldQty = currentItems[itemIndex].qty;
                    const oldName = currentItems[itemIndex].nama;
                    const oldMasterItem = masterItems.find(mi => mi.name === oldName);
                    if (oldMasterItem) {
                        oldMasterItem.stock -= oldQty; // Kurangi stok dari master
                    }

                    currentItems[itemIndex].nama = namaBarang;
                    currentItems[itemIndex].qty = jumlahKuantitas;
                    currentItems[itemIndex].hargaBeli = hargaBeli;
                    currentItems[itemIndex].jumlah = jumlah;

                    // Tambahkan stok untuk kuantitas baru
                    const newMasterItem = masterItems.find(mi => mi.name === namaBarang);
                    if (newMasterItem) {
                        newMasterItem.stock += jumlahKuantitas; // Tambahkan stok di master
                    }
                }
                editingItemId = null;
                document.getElementById('btnAddUpdatePembelian').innerText = 'Tambah Barang';
                document.getElementById('btnCancelEditPembelian').style.display = 'none';
            } else {
                itemCounter++;
                const newItem = {
                    id: itemCounter,
                    nama: namaBarang,
                    qty: jumlahKuantitas,
                    hargaBeli: hargaBeli,
                    jumlah: jumlah
                };
                currentItems.push(newItem);

                // Tambahkan stok untuk barang yang dibeli
                const masterItem = masterItems.find(mi => mi.name === namaBarang);
                if (masterItem) {
                    masterItem.stock += jumlahKuantitas;
                } else {
                    // Jika ini item baru, tambahkan ke masterItems dengan stok awal
                    masterItems.push({ name: namaBarang, price: 0, purchasePrice: hargaBeli, stock: jumlahKuantitas });
                }
            }
            saveMasterItems(); // Simpan master item setelah perubahan stok

            hitungUlangTotal('pembelian');
            renderTablePembelian();
            clearBarangInputs('pembelian');
            document.getElementById('strukOutputPembelian').style.display = 'none'; // Sembunyikan pratinjau saat menambah/mengedit
            document.getElementById('shareButtonsPembelian').style.display = 'none';
        }

        function editBarangPembelian(id) {
            const itemToEdit = currentItems.find(item => item.id === id);
            if (itemToEdit) {
                document.getElementById('namaBarangPembelian').value = itemToEdit.nama;
                document.getElementById('jumlahKuantitasPembelian').value = itemToEdit.qty;
                document.getElementById('hargaBeliPembelian').value = itemToEdit.hargaBeli;

                document.getElementById('btnAddUpdatePembelian').innerText = 'Update Barang';
                document.getElementById('btnCancelEditPembelian').style.display = 'inline-block';
                editingItemId = id;
            }
        }

        function deleteBarangPembelian(id) {
            showMessageBox('Apakah Anda yakin ingin menghapus barang ini dari daftar saat ini?', true, () => {
                const deletedItem = currentItems.find(item => item.id === id);
                if (deletedItem) {
                    // Kurangi stok untuk item yang dihapus (batalkan pembelian)
                    const masterItem = masterItems.find(mi => mi.name === deletedItem.nama);
                    if (masterItem) {
                        masterItem.stock -= deletedItem.qty;
                    }
                    saveMasterItems();
                }
                currentItems = currentItems.filter(item => item.id !== id);
                hitungUlangTotal('pembelian');
                renderTablePembelian();
                batalEditPembelian();
                document.getElementById('strukOutputPembelian').style.display = 'none'; // Sembunyikan pratinjau jika item dihapus
                document.getElementById('shareButtonsPembelian').style.display = 'none';
            });
        }

        function batalEditPembelian() {
            editingItemId = null;
            document.getElementById('btnAddUpdatePembelian').innerText = 'Tambah Barang';
            document.getElementById('btnCancelEditPembelian').style.display = 'none';
            clearBarangInputs('pembelian');
        }

        function renderTablePembelian() {
            const daftarBelanja = document.getElementById('daftarBelanjaPembelian');
            daftarBelanja.innerHTML = '';

            if (currentItems.length === 0) {
                daftarBelanja.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada barang dalam daftar pembelian.</td></tr>';
            }

            currentItems.forEach(item => {
                const row = daftarBelanja.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = item.id;
                row.insertCell(1).innerText = item.nama;
                row.insertCell(2).innerText = item.qty;
                row.insertCell(3).innerText = formatRupiah(item.hargaBeli);
                row.insertCell(4).innerText = formatRupiah(item.jumlah);

                const actionCell = row.insertCell(5);
                actionCell.classList.add('action-buttons', 'flex', 'gap-2', 'py-2');
                const editButton = document.createElement('button');
                editButton.innerText = 'Edit';
                editButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                editButton.onclick = () => editBarangPembelian(item.id);
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deleteBarangPembelian(item.id);
                actionCell.appendChild(deleteButton);
            });
        }

        function simpanNotaPembelian() {
            if (currentItems.length === 0) {
                showMessageBox('Tidak ada barang untuk disimpan dalam nota pembelian.');
                return;
            }

            const tanggal = document.getElementById('tanggalPembelian').value;
            const namaSupplier = document.getElementById('namaSupplier').value || 'Supplier Umum';
            const namaToko = document.getElementById('namaToko').value || 'Nama Toko';

            const newStruk = {
                id: Date.now(),
                tanggal: tanggal,
                supplier: namaSupplier,
                toko: namaToko,
                items: JSON.parse(JSON.stringify(currentItems)),
                totalPembelian: currentGrandTotalPembelian
            };

            purchaseHistory.push(newStruk);
            localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));

            renderStrukPreviewPembelian(newStruk);
            document.getElementById('strukOutputPembelian').style.display = 'block';
            document.getElementById('shareButtonsPembelian').style.display = 'flex';
            showMessageBox('Nota pembelian berhasil disimpan!');
            resetCurrentTransaction('pembelian');
        }

        function renderStrukPreviewPembelian(strukData) {
            const namaToko = strukData.toko || 'Nama Toko';
            const tanggal = strukData.tanggal;
            const namaSupplier = strukData.supplier || 'Supplier Umum';

            document.getElementById('strukNamaSupplierPembelian').innerText = `Nama Toko: ${namaToko}`;
            document.getElementById('strukTanggalPembelianPreview').innerText = `Tanggal: ${tanggal} | Supplier: ${namaSupplier}`;

            const strukItemsDiv = document.getElementById('strukItemsPembelian');
            strukItemsDiv.innerHTML = '';

            strukData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item-row', 'flex', 'justify-between', 'flex-wrap', 'mb-1');
                itemDiv.innerHTML = `
                    <span class="item-name flex-1 min-w-[50%]">${item.nama}</span>
                    <span class="item-qty-price text-right flex-grow-0 flex-shrink-0 w-[120px]">${item.qty} x ${formatRupiah(item.hargaBeli)}</span>
                    <span class="item-total w-[80px] text-right ml-auto">${formatRupiah(item.jumlah)}</span>
                `;
                strukItemsDiv.appendChild(itemDiv);
            });
            document.getElementById('strukGrandTotalPembelianPreview').innerText = `Total: ${formatRupiah(strukData.totalPembelian)}`;
        }

        function shareViaWhatsAppPembelian() {
            const lastStruk = purchaseHistory[purchaseHistory.length - 1];
            if (!lastStruk) {
                showMessageBox('Tidak ada nota pembelian untuk dibagikan.');
                return;
            }

            const namaToko = lastStruk.toko || 'Nama Toko';
            const tanggal = lastStruk.tanggal;
            const namaSupplier = lastStruk.supplier || 'Supplier Umum';

            let message = `*NOTA PEMBELIAN*\n\n`;
            message += `*${namaToko}*\n`;
            message += `Tanggal: ${tanggal}\n`;
            message += `Supplier: ${namaSupplier}\n`;
            message += `\n`;

            message += `*Daftar Barang:*\n`;
            lastStruk.items.forEach((item, index) => {
                message += `${index + 1}. ${item.nama} (${item.qty} x ${formatRupiah(item.hargaBeli)}) = ${formatRupiah(item.jumlah)}\n`;
            });

            message += `\n------------------------------\n`;
            message += `*TOTAL PEMBELIAN: ${formatRupiah(lastStruk.totalPembelian)}*\n`;
            message += `------------------------------\n`;
            message += `\nTerima kasih!\n`;
            message += `_Dibuat dengan Aplikasi Nota & Stok_`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }


        // --- Nama Toko Management ---
        function loadNamaToko() {
            const storedNamaToko = localStorage.getItem('namaToko');
            if (storedNamaToko) {
                document.getElementById('namaToko').value = storedNamaToko;
            }
            document.getElementById('namaToko').addEventListener('input', () => {
                localStorage.setItem('namaToko', document.getElementById('namaToko').value);
            });
        }

        // --- History Management ---
        function loadHistory() {
            const storedSalesHistory = localStorage.getItem('salesHistory');
            if (storedSalesHistory) {
                salesHistory = JSON.parse(storedSalesHistory);
            }
            const storedPurchaseHistory = localStorage.getItem('purchaseHistory');
            if (storedPurchaseHistory) {
                purchaseHistory = JSON.parse(storedPurchaseHistory);
            }
            renderSalesHistory();
            renderPurchaseHistory();
        }

        function renderSalesHistory() {
            const historyListBody = document.querySelector('#salesHistoryListBody');
            historyListBody.innerHTML = '';

            if (salesHistory.length === 0) {
                historyListBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada riwayat penjualan.</td></tr>';
                return;
            }

            salesHistory.forEach(struk => {
                const row = historyListBody.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = struk.id;
                row.insertCell(1).innerText = struk.tanggal;
                row.insertCell(2).innerText = struk.pembeli;
                row.insertCell(3).innerText = formatRupiah(struk.totalPenjualan);
                row.insertCell(4).innerText = formatRupiah(struk.totalLabaRugi || 0);

                const actionCell = row.insertCell(5);
                actionCell.classList.add('history-actions', 'flex', 'gap-2', 'py-2');

                const viewButton = document.createElement('button');
                viewButton.innerText = 'Lihat';
                viewButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                viewButton.onclick = () => viewHistoryStruk(struk.id, 'penjualan');
                actionCell.appendChild(viewButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deleteHistoryStruk(struk.id, 'penjualan');
                actionCell.appendChild(deleteButton);
            });
        }

        function renderPurchaseHistory() {
            const historyListBody = document.querySelector('#purchaseHistoryListBody');
            historyListBody.innerHTML = '';

            if (purchaseHistory.length === 0) {
                historyListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada riwayat pembelian.</td></tr>';
                return;
            }

            purchaseHistory.forEach(struk => {
                const row = historyListBody.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = struk.id;
                row.insertCell(1).innerText = struk.tanggal;
                row.insertCell(2).innerText = struk.supplier;
                row.insertCell(3).innerText = formatRupiah(struk.totalPembelian);

                const actionCell = row.insertCell(4);
                actionCell.classList.add('history-actions', 'flex', 'gap-2', 'py-2');

                const viewButton = document.createElement('button');
                viewButton.innerText = 'Lihat';
                viewButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                viewButton.onclick = () => viewHistoryStruk(struk.id, 'pembelian');
                actionCell.appendChild(viewButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deleteHistoryStruk(struk.id, 'pembelian');
                actionCell.appendChild(deleteButton);
            });
        }

        function viewHistoryStruk(id, type) {
            let strukToView;
            if (type === 'penjualan') {
                strukToView = salesHistory.find(s => s.id === id);
                if (strukToView) {
                    // Isi form penjualan dengan data riwayat
                    document.getElementById('namaToko').value = strukToView.toko || '';
                    document.getElementById('tanggalPenjualan').value = strukToView.tanggal;
                    document.getElementById('namaPembeli').value = strukToView.pembeli;
                    currentItems = JSON.parse(JSON.stringify(strukToView.items)); // Muat item ke currentItems

                    hitungUlangTotal('penjualan'); // Hitung ulang total untuk item yang dimuat
                    renderTablePenjualan(); // Render tabel daftar belanja dengan item yang dimuat

                    // Render pratinjau struk riwayat ini
                    renderStrukPreviewPenjualan(strukToView);
                    document.getElementById('strukOutputPenjualan').style.display = 'block';
                    document.getElementById('shareButtonsPenjualan').style.display = 'flex';

                    showMessageBox(`Menampilkan struk penjualan riwayat dengan ID: ${strukToView.id}`);
                    // Beralih ke tab penjualan, dan *pertahankan* data transaksi saat ini di form
                    showSection('penjualan', document.getElementById('navPenjualan'), true);
                }
            } else if (type === 'pembelian') {
                strukToView = purchaseHistory.find(s => s.id === id);
                if (strukToView) {
                    // Isi form pembelian dengan data riwayat
                    document.getElementById('namaToko').value = strukToView.toko || ''; // Asumsi namaToko bersifat global atau dibagikan
                    document.getElementById('tanggalPembelian').value = strukToView.tanggal;
                    document.getElementById('namaSupplier').value = strukToView.supplier;
                    currentItems = JSON.parse(JSON.stringify(strukToView.items)); // Muat item ke currentItems

                    hitungUlangTotal('pembelian'); // Hitung ulang total untuk item yang dimuat
                    renderTablePembelian(); // Render tabel daftar pembelian dengan item yang dimuat

                    renderStrukPreviewPembelian(strukToView);
                    document.getElementById('strukOutputPembelian').style.display = 'block';
                    document.getElementById('shareButtonsPembelian').style.display = 'flex';

                    showMessageBox(`Menampilkan nota pembelian riwayat dengan ID: ${strukToView.id}`);
                    // Beralih ke tab pembelian, dan *pertahankan* data transaksi saat ini di form
                    showSection('pembelian', document.getElementById('navPembelian'), true);
                }
            }
        }

        function deleteHistoryStruk(id, type) {
            showMessageBox(`Apakah Anda yakin ingin menghapus struk ${type} ini dari riwayat?`, true, () => {
                if (type === 'penjualan') {
                    const deletedStruk = salesHistory.find(s => s.id === id);
                    if (deletedStruk && deletedStruk.items) {
                        deletedStruk.items.forEach(item => {
                            const masterItem = masterItems.find(mi => mi.name === item.nama);
                            if (masterItem) {
                                masterItem.stock += item.qty; // Kembalikan stok untuk penjualan yang dihapus
                            }
                        });
                        saveMasterItems();
                    }
                    salesHistory = salesHistory.filter(s => s.id !== id);
                    localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
                    renderSalesHistory();
                    showMessageBox('Struk penjualan berhasil dihapus dari riwayat.');
                } else if (type === 'pembelian') {
                    const deletedStruk = purchaseHistory.find(s => s.id === id);
                    if (deletedStruk && deletedStruk.items) {
                        deletedStruk.items.forEach(item => {
                            const masterItem = masterItems.find(mi => mi.name === item.nama);
                            if (masterItem) {
                                masterItem.stock -= item.qty; // Kurangi stok untuk pembelian yang dihapus
                            }
                        });
                        saveMasterItems();
                    }
                    purchaseHistory = purchaseHistory.filter(s => s.id !== id);
                    localStorage.setItem('purchaseHistory', JSON.stringify(purchaseHistory));
                    renderPurchaseHistory();
                    showMessageBox('Nota pembelian berhasil dihapus dari riwayat.');
                }
            });
        }

        function clearSalesHistory() {
            showMessageBox('Apakah Anda yakin ingin menghapus SEMUA riwayat penjualan? Tindakan ini tidak dapat dibatalkan.', true, () => {
                // Ini TIDAK mengembalikan perubahan stok.
                localStorage.removeItem('salesHistory');
                salesHistory = [];
                renderSalesHistory();
                showMessageBox('Semua riwayat penjualan telah dihapus.');
            });
        }

        function clearPurchaseHistory() {
            showMessageBox('Apakah Anda yakin ingin menghapus SEMUA riwayat pembelian? Tindakan ini tidak dapat dibatalkan.', true, () => {
                // Ini TIDAK mengembalikan perubahan stok.
                localStorage.removeItem('purchaseHistory');
                purchaseHistory = [];
                renderPurchaseHistory();
                showMessageBox('Semua riwayat pembelian telah dihapus.');
            });
        }

        // --- Pending Sales Management ---
        function loadPendingSales() {
            const storedPendingSales = localStorage.getItem('pendingSales');
            if (storedPendingSales) {
                pendingSales = JSON.parse(storedPendingSales);
            }
            renderPendingSales();
        }

        function renderPendingSales() {
            const pendingSalesListBody = document.querySelector('#pendingSalesList');
            pendingSalesListBody.innerHTML = '';

            if (pendingSales.length === 0) {
                pendingSalesListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada transaksi pending.</td></tr>';
                return;
            }

            pendingSales.forEach(transaction => {
                const row = pendingSalesListBody.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = transaction.id;
                row.insertCell(1).innerText = transaction.tanggal;
                row.insertCell(2).innerText = transaction.pembeli;
                row.insertCell(3).innerText = formatRupiah(transaction.totalPenjualan);

                const actionCell = row.insertCell(4);
                actionCell.classList.add('action-buttons', 'flex', 'gap-2', 'py-2');

                const continueButton = document.createElement('button');
                continueButton.innerText = 'Lanjutkan';
                continueButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                continueButton.onclick = () => loadPendingTransaction(transaction.id);
                actionCell.appendChild(continueButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deletePendingTransaction(transaction.id);
                actionCell.appendChild(deleteButton);
            });
        }

        function loadPendingTransaction(id) {
            const transactionToLoad = pendingSales.find(t => t.id === id);
            if (transactionToLoad) {
                // Isi form penjualan dengan data transaksi pending
                document.getElementById('namaToko').value = transactionToLoad.toko || '';
                document.getElementById('tanggalPenjualan').value = transactionToLoad.tanggal;
                document.getElementById('namaPembeli').value = transactionToLoad.pembeli;
                currentItems = JSON.parse(JSON.stringify(transactionToLoad.items)); // Muat item ke currentItems

                hitungUlangTotal('penjualan'); // Hitung ulang total untuk item yang dimuat
                renderTablePenjualan(); // Render tabel daftar belanja dengan item yang dimuat

                // Beralih ke tab penjualan, dan *pertahankan* data transaksi saat ini di form
                showSection('penjualan', document.getElementById('navPenjualan'), true);

                // Pastikan pratinjau dikosongkan saat memuat transaksi pending untuk dikerjakan
                clearSalesPreview(); 

                showMessageBox(`Transaksi pending dengan ID ${id} dimuat. Lanjutkan pembayaran.`);

                // Hapus dari daftar pending setelah dimuat
                pendingSales = pendingSales.filter(t => t.id !== id);
                localStorage.setItem('pendingSales', JSON.stringify(pendingSales));
                renderPendingSales();
            }
        }

        function deletePendingTransaction(id) {
            showMessageBox('Apakah Anda yakin ingin menghapus transaksi pending ini?', true, () => {
                pendingSales = pendingSales.filter(t => t.id !== id);
                localStorage.setItem('pendingSales', JSON.stringify(pendingSales));
                renderPendingSales();
                showMessageBox('Transaksi pending berhasil dihapus.');
            });
        }

        function clearPendingSales() {
            showMessageBox('Apakah Anda yakin ingin menghapus SEMUA transaksi pending? Tindakan ini tidak dapat dibatalkan.', true, () => {
                localStorage.removeItem('pendingSales');
                pendingSales = [];
                renderPendingSales();
                showMessageBox('Semua transaksi pending telah dihapus.');
            });
        }

        // --- Master Items Management (Autocomplete, Storage, & Modal) ---
        function addOrUpdateMasterItem(name, sellingPrice, purchasePrice, stockChange = 0) {
            const existingItemIndex = masterItems.findIndex(item => item.name.toLowerCase() === name.toLowerCase());
            if (existingItemIndex > -1) {
                masterItems[existingItemIndex].price = sellingPrice;
                masterItems[existingItemIndex].purchasePrice = purchasePrice;
                masterItems[existingItemIndex].stock = (masterItems[existingItemIndex].stock || 0) + stockChange;
            } else {
                masterItems.push({ name: name, price: sellingPrice, purchasePrice: purchasePrice, stock: stockChange });
            }
            saveMasterItems();
            renderMasterItems();
            renderModalMasterItems();
        }

        function saveMasterItems() {
            localStorage.setItem('masterItems', JSON.stringify(masterItems));
        }

        function loadMasterItems() {
            const storedMasterItems = localStorage.getItem('masterItems');
            if (storedMasterItems) {
                masterItems = JSON.parse(storedMasterItems);
                masterItems.forEach(item => {
                    if (typeof item.stock === 'undefined') item.stock = 0;
                    if (typeof item.purchasePrice === 'undefined') item.purchasePrice = 0;
                });
            }
            renderMasterItems();
        }

        function renderMasterItems() {
            const masterItemsListBody = document.querySelector('#masterItemsList');
            masterItemsListBody.innerHTML = '';

            if (masterItems.length === 0) {
                masterItemsListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada barang master.</td></tr>';
                return;
            }

            masterItems.forEach((item, index) => {
                const row = masterItemsListBody.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = item.name;
                row.insertCell(1).innerText = formatRupiah(item.price);
                row.insertCell(2).innerText = formatRupiah(item.purchasePrice);
                row.insertCell(3).innerText = item.stock;

                const actionCell = row.insertCell(4);
                actionCell.classList.add('master-item-actions', 'flex', 'gap-2', 'py-2');

                const editButton = document.createElement('button');
                editButton.innerText = 'Edit';
                editButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                editButton.onclick = () => editMasterItem(index);
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Hapus';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                deleteButton.onclick = () => deleteMasterItem(index);
                actionCell.appendChild(deleteButton);
            });
        }

        function editMasterItem(index) {
            const itemToEdit = masterItems[index];
            if (itemToEdit) {
                // Isi form penjualan dengan field
                document.getElementById('namaBarangPenjualan').value = itemToEdit.name;
                document.getElementById('hargaSatuanPenjualan').value = itemToEdit.price;
                document.getElementById('hargaBeliPenjualan').value = itemToEdit.purchasePrice;
                document.getElementById('jumlahKuantitasPenjualan').value = '';
                document.getElementById('namaBarangPenjualan').focus();
                showSection('penjualan', document.getElementById('navPenjualan'));
            }
        }

        function deleteMasterItem(index) {
            showMessageBox(`Apakah Anda yakin ingin menghapus "${masterItems[index].name}" dari daftar barang master?`, true, () => {
                masterItems.splice(index, 1);
                saveMasterItems();
                renderMasterItems();
                renderModalMasterItems();
                showMessageBox('Barang master berhasil dihapus.');
            });
        }

        function clearMasterItems() {
            showMessageBox('Apakah Anda yakin ingin menghapus SEMUA daftar barang master? Tindakan ini tidak dapat dibatalkan.', true, () => {
                localStorage.removeItem('masterItems');
                masterItems = [];
                renderMasterItems();
                renderModalMasterItems();
                showMessageBox('Semua daftar barang master telah dihapus.');
            });
        }

        // Autocomplete logic
        function showSuggestions(type) {
            let inputElement, suggestionsDivElement;
            if (type === 'penjualan') {
                inputElement = document.getElementById('namaBarangPenjualan');
                suggestionsDivElement = document.getElementById('namaBarangSuggestionsPenjualan');
            } else if (type === 'pembelian') {
                inputElement = document.getElementById('namaBarangPembelian');
                suggestionsDivElement = document.getElementById('namaBarangSuggestionsPembelian');
            } else {
                return;
            }

            const filter = inputElement.value.toLowerCase();
            suggestionsDivElement.innerHTML = '';

            if (!filter) {
                return;
            }

            const filteredItems = masterItems.filter(item =>
                item.name.toLowerCase().includes(filter)
            );

            filteredItems.forEach(item => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100', 'border-b', 'border-gray-200', 'last:border-b-0');
                suggestionItem.innerText = `${item.name} (Jual: ${formatRupiah(item.price)} | Beli: ${formatRupiah(item.purchasePrice)})`;
                suggestionItem.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    inputElement.value = item.name;
                    if (type === 'penjualan') {
                        document.getElementById('hargaSatuanPenjualan').value = item.price;
                        document.getElementById('hargaBeliPenjualan').value = item.purchasePrice;
                        document.getElementById('jumlahKuantitasPenjualan').focus();
                    } else if (type === 'pembelian') {
                        document.getElementById('hargaBeliPembelian').value = item.purchasePrice;
                        document.getElementById('jumlahKuantitasPembelian').focus();
                    }
                    suggestionsDivElement.innerHTML = '';
                });
                suggestionsDivElement.appendChild(suggestionItem);
            });
        }

        // --- Master Item Search Modal ---
        function openMasterItemModal(callerType) {
            currentTransactionType = callerType; // Simpan bagian mana yang memanggil modal
            document.getElementById('masterItemModal').style.display = 'flex';
            renderModalMasterItems();
            document.getElementById('masterItemSearchInput').value = '';
            document.getElementById('masterItemSearchInput').focus();
        }

        function closeMasterItemModal() {
            document.getElementById('masterItemModal').style.display = 'none';
        }

        function renderModalMasterItems() {
            const modalListBody = document.getElementById('modalMasterItemsList');
            modalListBody.innerHTML = '';
            const searchFilter = document.getElementById('masterItemSearchInput').value.toLowerCase();

            const filteredMasterItems = masterItems.filter(item =>
                item.name.toLowerCase().includes(searchFilter)
            );

            if (filteredMasterItems.length === 0) {
                modalListBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Tidak ada barang yang cocok.</td></tr>';
                return;
            }

            filteredMasterItems.forEach(item => {
                const row = modalListBody.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = item.name;
                row.insertCell(1).innerText = formatRupiah(item.price);
                row.insertCell(2).innerText = formatRupiah(item.purchasePrice);
                row.insertCell(3).innerText = item.stock;
                const selectCell = row.insertCell(4);
                const selectButton = document.createElement('button');
                selectButton.innerText = 'Pilih';
                selectButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white', 'py-1', 'px-2', 'rounded-md', 'text-xs');
                selectButton.onclick = () => selectMasterItemFromModal(item.name, item.price, item.purchasePrice);
                selectCell.appendChild(selectButton);
            });
        }

        document.getElementById('masterItemSearchInput').addEventListener('input', renderModalMasterItems);

        function selectMasterItemFromModal(name, sellingPrice, purchasePrice) {
            if (currentTransactionType === 'penjualan') {
                document.getElementById('namaBarangPenjualan').value = name;
                document.getElementById('hargaSatuanPenjualan').value = sellingPrice;
                document.getElementById('hargaBeliPenjualan').value = purchasePrice;
                document.getElementById('jumlahKuantitasPenjualan').value = '';
                document.getElementById('jumlahKuantitasPenjualan').focus();
            } else if (currentTransactionType === 'pembelian') {
                document.getElementById('namaBarangPembelian').value = name;
                document.getElementById('hargaBeliPembelian').value = purchasePrice;
                document.getElementById('jumlahKuantitasPembelian').value = '';
                document.getElementById('jumlahKuantitasPembelian').focus();
            }
            closeMasterItemModal();
        }

        // --- Backup / Restore Master Items ---
        function backupMasterItems() {
            if (masterItems.length === 0) {
                showMessageBox('Tidak ada barang master untuk di-backup.');
                return;
            }
            const dataStr = JSON.stringify(masterItems, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `master_barang_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessageBox('Daftar barang master berhasil di-backup!');
        }

        function restoreMasterItems(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData) && loadedData.every(item => typeof item.name === 'string' && typeof item.price === 'number' && typeof item.purchasePrice === 'number' && typeof item.stock === 'number')) {
                        showMessageBox('Apakah Anda yakin ingin me-restore daftar barang master? Ini akan menimpa data yang ada.', true, () => {
                            masterItems = loadedData;
                            saveMasterItems();
                            renderMasterItems();
                            renderModalMasterItems();
                            showMessageBox('Daftar barang master berhasil di-restore!');
                        });
                    } else {
                        showMessageBox('Format file JSON tidak valid. Pastikan itu adalah array objek dengan "name" (string), "price" (number), "purchasePrice" (number), dan "stock" (number).');
                    }
                } catch (error) {
                    showMessageBox('Gagal membaca atau memproses file JSON. Error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- Laporan Rugi Laba Sederhana ---
        function generateProfitLossReport() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const filterItemName = document.getElementById('filterItemName').value.toLowerCase();

            let filteredSalesHistory = salesHistory.filter(struk => {
                const strukDate = struk.tanggal;
                return (!startDate || strukDate >= startDate) && (!endDate || strukDate <= endDate);
            });

            if (filterItemName) {
                filteredSalesHistory = filteredSalesHistory.filter(struk =>
                    struk.items.some(item => item.nama.toLowerCase().includes(filterItemName))
                );
            }

            // Rugi Laba Harian
            const dailyProfitLoss = {};
            filteredSalesHistory.forEach(struk => {
                const date = struk.tanggal;
                if (!dailyProfitLoss[date]) {
                    dailyProfitLoss[date] = { totalPenjualan: 0, totalHargaBeli: 0, labaRugi: 0 };
                }
                dailyProfitLoss[date].totalPenjualan += struk.totalPenjualan;
                let totalBeliTransaksi = struk.items.reduce((sum, item) => sum + (item.qty * (item.hargaBeli || 0)), 0);
                dailyProfitLoss[date].totalHargaBeli += totalBeliTransaksi;
                dailyProfitLoss[date].labaRugi += struk.totalLabaRugi;
            });

            const dailyProfitLossList = document.getElementById('dailyProfitLossList');
            dailyProfitLossList.innerHTML = '';
            let overallTotalFilteredProfitLoss = 0;

            Object.keys(dailyProfitLoss).sort().forEach(date => {
                const data = dailyProfitLoss[date];
                const row = dailyProfitLossList.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = date;
                row.insertCell(1).innerText = formatRupiah(data.totalPenjualan);
                row.insertCell(2).innerText = formatRupiah(data.totalHargaBeli);
                row.insertCell(3).innerText = formatRupiah(data.labaRugi);
                overallTotalFilteredProfitLoss += data.labaRugi;
            });
            if (Object.keys(dailyProfitLoss).length === 0) {
                 dailyProfitLossList.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Tidak ada data rugi laba harian.</td></tr>';
            }


            // Rugi Laba per Transaksi
            const transactionProfitLossList = document.getElementById('transactionProfitLossList');
            transactionProfitLossList.innerHTML = '';
            filteredSalesHistory.forEach(struk => {
                const row = transactionProfitLossList.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = struk.id;
                row.insertCell(1).innerText = struk.tanggal;
                row.insertCell(2).innerText = struk.pembeli;
                row.insertCell(3).innerText = formatRupiah(struk.totalPenjualan);
                let totalBeliTransaksi = struk.items.reduce((sum, item) => sum + (item.qty * (item.hargaBeli || 0)), 0);
                row.insertCell(4).innerText = formatRupiah(totalBeliTransaksi);
                row.insertCell(5).innerText = formatRupiah(struk.totalLabaRugi || 0);
            });
            if (filteredSalesHistory.length === 0) {
                transactionProfitLossList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data rugi laba per transaksi.</td></tr>';
            }


            // Rugi Laba per Barang
            const itemProfitLoss = {};
            filteredSalesHistory.forEach(struk => {
                struk.items.forEach(item => {
                    if (!itemProfitLoss[item.nama]) {
                        itemProfitLoss[item.nama] = { totalPenjualan: 0, totalHargaBeli: 0, labaRugi: 0 };
                    }
                    itemProfitLoss[item.nama].totalPenjualan += item.jumlah;
                    itemProfitLoss[item.nama].totalHargaBeli += (item.qty * (item.hargaBeli || 0));
                    itemProfitLoss[item.nama].labaRugi += item.labaRugi;
                });
            });

            const itemProfitLossList = document.getElementById('itemProfitLossList');
            itemProfitLossList.innerHTML = '';
            Object.keys(itemProfitLoss).sort().forEach(itemName => {
                const data = itemProfitLoss[itemName];
                const row = itemProfitLossList.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = itemName;
                row.insertCell(1).innerText = formatRupiah(data.totalPenjualan);
                row.insertCell(2).innerText = formatRupiah(data.totalHargaBeli);
                row.insertCell(3).innerText = formatRupiah(data.labaRugi);
            });
            if (Object.keys(itemProfitLoss).length === 0) {
                itemProfitLossList.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Tidak ada data rugi laba per barang.</td></tr>';
            }

            document.getElementById('totalFilteredProfitLoss').innerText = formatRupiah(overallTotalFilteredProfitLoss);
        }

        // --- Laporan Stok Barang Sederhana ---
        function generateStockReport() {
            const stockReportList = document.getElementById('stockReportList');
            stockReportList.innerHTML = '';
            const stockFilterItemName = document.getElementById('stockFilterItemName').value.toLowerCase();

            let filteredMasterItems = masterItems;
            if (stockFilterItemName) {
                filteredMasterItems = masterItems.filter(item =>
                    item.name.toLowerCase().includes(stockFilterItemName)
                );
            }

            if (filteredMasterItems.length === 0) {
                stockReportList.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Tidak ada barang master yang cocok untuk laporan stok.</td></tr>';
                return;
            }

            filteredMasterItems.forEach(item => {
                const row = stockReportList.insertRow();
                row.classList.add('hover:bg-gray-50');
                row.insertCell(0).innerText = item.name;
                row.insertCell(1).innerText = item.stock;
                row.insertCell(2).innerText = formatRupiah(item.price);
                row.insertCell(3).innerText = formatRupiah(item.purchasePrice);
            });
        }

        // Custom Message Box (replacing alert and confirm)
        function showMessageBox(message, isConfirm = false, onConfirm = null) {
            const modalId = 'customMessageBox';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.classList.add('modal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close-button" onclick="closeMessageBox()">&times;</span>
                        <p id="messageBoxText" class="text-gray-800 text-base mb-6"></p>
                        <div class="flex justify-center gap-4">
                            <button id="messageBoxConfirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200" style="display: none;">OK</button>
                            <button id="messageBoxCancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200" style="display: none;">Batal</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('messageBoxText').innerText = message;
            const confirmBtn = document.getElementById('messageBoxConfirmBtn');
            const cancelBtn = document.getElementById('messageBoxCancelBtn');

            if (isConfirm) {
                confirmBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                confirmBtn.onclick = () => {
                    closeMessageBox();
                    if (onConfirm) onConfirm();
                };
                cancelBtn.onclick = () => closeMessageBox();
            } else {
                confirmBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'none';
                confirmBtn.onclick = () => closeMessageBox();
            }

            modal.style.display = 'flex';
        }

        function closeMessageBox() {
            const modal = document.getElementById('customMessageBox');
            if (modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
